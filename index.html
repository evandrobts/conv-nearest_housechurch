<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Localizador de Igrejas Caseiras</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #2D2D2D; color: #2D2D2D; }
    #loading-spinner { border-top-color: #DBD6D2; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg) } 100% { transform: rotate(360deg) } }
  </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">
  <div class="bg-[#DBD6D2] p-8 rounded-xl shadow-lg w-full max-w-lg">
    <div class="flex justify-center mb-6">
      <img src="cnv_logo_1.png" alt="Igreja Convergência Campinas" class="w-full max-w-xs mx-auto">
    </div>

    <div class="text-center mb-6">
      <h1 class="text-2xl font-bold mb-2">Encontre uma Igreja Caseira</h1>
      <p class="text-sm opacity-80">Descubra as reuniões mais próximas do seu endereço</p>
    </div>

    <form id="search-form" class="space-y-4">
      <div>
        <label for="address" class="block text-sm font-medium">Seu Endereço ou CEP</label>
        <input
          type="text"
          id="address"
          name="address"
          required
          placeholder="Ex: Av. Brasil, 1234, Campinas ou 13084-210"
          class="mt-1 shadow-sm focus:ring-[#2D2D2D] focus:border-[#2D2D2D] block w-full sm:text-sm border-gray-300 rounded-md p-3"
        />
      </div>

      <div class="grid grid-cols-2 gap-3">
        <div>
          <label for="limit" class="block text-sm font-medium">Quantos resultados?</label>
          <input
            type="number" id="limit" min="1" max="10" value="3"
            class="mt-1 shadow-sm focus:ring-[#2D2D2D] focus:border-[#2D2D2D] block w-full sm:text-sm border-gray-300 rounded-md p-3"
          />
        </div>
        <div>
          <label for="max-distance" class="block text-sm font-medium">Raio (km) <span class="opacity-60 text-xs">(opcional)</span></label>
          <input
            type="number" id="max-distance" min="1" step="0.1" placeholder="ex.: 10"
            class="mt-1 shadow-sm focus:ring-[#2D2D2D] focus:border-[#2D2D2D] block w-full sm:text-sm border-gray-300 rounded-md p-3"
          />
        </div>
      </div>

      <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
        <button
          type="submit" id="search-button"
          class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-[#2D2D2D] hover:bg-gray-700 transition-colors"
        >
          Buscar
        </button>

        <button
          type="button" id="geo-button"
          class="w-full flex justify-center items-center gap-2 py-3 px-4 border rounded-md shadow-sm text-sm font-medium text-[#2D2D2D] bg-white hover:bg-gray-100 transition-colors"
          title="Usar minha localização atual"
        >
          <i class="fas fa-location-crosshairs"></i>
          Usar minha localização
        </button>
      </div>
    </form>

    <div id="loading-spinner" class="hidden mx-auto my-6 w-8 h-8 rounded-full border-4 border-gray-300"></div>

    <!-- Endereço interpretado -->
    <div id="query-head" class="hidden mt-8 bg-white/70 rounded-lg p-4">
      <div class="flex items-start gap-3">
        <i class="fas fa-location-dot mt-1"></i>
        <div class="text-sm">
          <p><strong>Seu local:</strong> <span id="q-addr"></span></p>
          <p class="mt-1">
            <a id="q-maps" href="#" target="_blank" class="underline text-[#2D2D2D] hover:opacity-80">
              Ver sua localização aproximada no Maps
            </a>
          </p>
        </div>
      </div>
    </div>

    <div id="results" class="mt-6 space-y-6"></div>

    <div class="mt-8 text-center">
      <p class="opacity-70 text-sm mb-2">Se tiver dúvidas, fale com a Secretaria da Igreja:</p>
      <a href="https://wa.me/5519992464650" target="_blank"
         class="inline-flex items-center px-4 py-2 text-sm font-medium rounded-md shadow-sm text-white bg-green-500 hover:bg-green-600 transition-colors">
        <i class="fab fa-whatsapp mr-2"></i>Falar com a Secretaria no WhatsApp
      </a>
    </div>
  </div>

  <script>
    const geoBtn = document.getElementById('geo-button');

    function setLoading(isLoading, label = 'Buscando...') {
      if (isLoading) {
        button.disabled = true;
        button.textContent = label;
        spinner.classList.remove('hidden');
        geoBtn.disabled = true;
        geoBtn.classList.add('opacity-60', 'pointer-events-none');
      } else {
        button.disabled = false;
        button.textContent = 'Buscar';
        spinner.classList.add('hidden');
        geoBtn.disabled = false;
        geoBtn.classList.remove('opacity-60', 'pointer-events-none');
      }
    }

    async function callApi(body) {
      const response = await fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body),
      });
      const data = await response.json();
      if (!response.ok) {
        throw new Error(data.error || 'Erro na requisição.');
      }
      return data;
    }

    function renderResult(data, md) {
      if (data.query?.input_address) {
        qAddr.textContent = data.query.input_address;
        if (data.query.maps_url) {
          qMaps.href = data.query.maps_url;
          qMaps.classList.remove('pointer-events-none', 'opacity-50');
        } else {
          qMaps.href = '#';
          qMaps.classList.add('pointer-events-none', 'opacity-50');
        }
        qHead.classList.remove('hidden');
      }
      const churches = data.nearest_churches || [];
      if (churches.length === 0) {
        resultsDiv.innerHTML = `<p class="text-center opacity-70">Nenhuma igreja encontrada${md ? ` no raio de ${md} km` : ''}.</p>`;
        return;
      }
      churches.forEach(ch => resultsDiv.appendChild(makeCard(ch)));
    }

    geoBtn.addEventListener('click', () => {
      if (!('geolocation' in navigator)) {
        alert('Seu navegador não suporta geolocalização.');
        return;
      }
      resultsDiv.innerHTML = '';
      qHead.classList.add('hidden');
      const limitVal = Number(limitEl.value) || 3;
      const md = Number(maxDistEl.value);
      setLoading(true, 'Localizando...');

      navigator.geolocation.getCurrentPosition(async (pos) => {
        try {
          const { latitude, longitude } = pos.coords;
          const body = { lat: latitude, lon: longitude, limit: limitVal };
          if (isFinite(md) && md > 0) body.max_distance_km = md;

          const data = await callApi(body);
          renderResult(data, md);
        } catch (err) {
          console.error(err);
          resultsDiv.innerHTML = `<p class="text-center text-red-600">Erro: ${err.message}</p>`;
        } finally {
          setLoading(false);
        }
      }, (err) => {
        console.error(err);
        let msg = 'Não foi possível obter sua localização.';
        if (err.code === 1) msg = 'Permissão de localização negada.';
        if (err.code === 2) msg = 'Posição indisponível.';
        if (err.code === 3) msg = 'Tempo esgotado para obter a posição.';
        resultsDiv.innerHTML = `<p class="text-center text-red-600">${msg}</p>`;
        setLoading(false);
      }, {
        enableHighAccuracy: true,
        timeout: 10000,
        maximumAge: 0,
      });
    });

    const API_URL = 'https://nearest-house-conv-891569474486.us-east5.run.app';

    const form = document.getElementById('search-form');
    const addressEl = document.getElementById('address');
    const limitEl = document.getElementById('limit');
    const maxDistEl = document.getElementById('max-distance');

    const resultsDiv = document.getElementById('results');
    const button = document.getElementById('search-button');
    const spinner = document.getElementById('loading-spinner');

    const qHead = document.getElementById('query-head');
    const qAddr = document.getElementById('q-addr');
    const qMaps = document.getElementById('q-maps');

    function extractPhones(raw) {
      if (!raw) return [];
      const chunks = raw.replace(/\D+/g, ' ').trim().split(/\s+/);
      return chunks.filter(d => d.length === 10 || d.length === 11);
    }
    function firstPhone(raw) {
      const arr = extractPhones(raw);
      return arr.length ? arr[0] : null;
    }

    function fmtKm(val) {
      const n = Number(val);
      return isFinite(n) ? n.toFixed(2) : val;
    }

    function getPhone(raw) {
      if (!raw) return null;
      let digits = raw.replace(/\D/g, '');
      if (digits.length > 11) digits = digits.slice(-11);
      if (digits.length === 10 || digits.length === 11) return digits;
      return null;
    }

    // ========= Bairro + Cidade (limpeza mais agressiva) =========
    function normalizeStr(s) {
      return String(s || '')
        .replace(/\b\d{5}-?\d{3}\b/g, '')   // remove CEP
        .replace(/,\s*Brasil$/i, '')        // remove "Brasil" no final
        .replace(/\s+/g, ' ')
        .replace(/,\s*,/g, ', ')
        .trim();
    }

    function cleanComplement(t) {
      // remove complementos comuns no começo do trecho
      t = t.replace(/^(ap\.?|apto\.?|apartamento|bl\.?|bloco|casa|condom[ií]nio)\b.*?/i, '').trim();
      // se ainda sobrou "número - " no começo (ex.: "579 - Jardim ..."), remove
      t = t.replace(/^\d+\s*-\s*/, '').trim();
      // se sobrou apenas número, zera
      if (/^\d+$/.test(t)) t = '';
      return t;
    }

    function parseAreaParts(addr) {
      const s = normalizeStr(addr);

      // A) Pegue a última ocorrência de "Cidade - UF"
      const reCidadeUF = /([A-Za-zÀ-ÿ .'-]+?)\s*-\s*([A-Z]{2})\b/gi;
      const cityMatches = [...s.matchAll(reCidadeUF)];
      if (cityMatches.length) {
        const m = cityMatches[cityMatches.length - 1];
        const cidade = (m[1] || '').trim();

        // Tudo que vem antes da cidade
        let before = s.slice(0, m.index).trim();
        // tente pegar o trecho depois da ÚLTIMA vírgula OU do ÚLTIMO hífen
        let bairro = before;
        if (bairro.includes(',')) bairro = bairro.split(',').pop().trim();
        if (bairro.includes('-')) bairro = bairro.split('-').pop().trim();

        bairro = cleanComplement(bairro);

        // se ainda ficou esquisito (muito curto ou vazio), tente por palavras-chave
        if (!bairro || bairro.length < 3) {
          const reKw = /(Jd\.?|Jardim|Vila|Parque|Residencial|Condom[ií]nio|Ch[aá]cara|Loteamento|Centro)\s+[A-Za-zÀ-ÿ0-9 .'-]{2,}/gi;
          const kwAll = [...before.matchAll(reKw)];
          if (kwAll.length) {
            bairro = cleanComplement(kwAll[kwAll.length - 1][0].trim());
          }
        }

        return { bairro, cidade };
      }

      // B) Como fallback, tente "Bairro, Cidade" sem UF explícito
      const reBairroCidade = /([^,\d][^,]*?),\s*([A-Za-zÀ-ÿ .'-]+)$/i;
      const m2 = s.match(reBairroCidade);
      if (m2) {
        let bairro = cleanComplement((m2[1] || '').trim());
        const cidade = (m2[2] || '').trim();
        return { bairro, cidade };
      }

      return { bairro: '', cidade: '' };
    }

    function formatArea(addr) {
      const { bairro, cidade } = parseAreaParts(addr);
      if (bairro && cidade) return `${bairro}, ${cidade}`;
      if (bairro) return bairro;
      if (cidade) return cidade;
      return 'Região próxima';
    }

    function mapsLinkForArea(addr, uf = 'SP') {
      const { bairro, cidade } = parseAreaParts(addr);
      const base = bairro && cidade ? `${bairro}, ${cidade} - ${uf}`
                 : cidade ? `${cidade} - ${uf}`
                 : 'Campinas - SP';
      return `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(base)}`;
    }
    // =============================================================

    function makeCard(church) {
      const card = document.createElement('div');
      card.className = 'bg-white p-6 rounded-lg shadow-inner';

      const phone = getPhone(church.contact);
      const whatsappLink = phone ? `https://wa.me/55${phone}` : null;

      const srcAddr = church.formatted_address || church.address || '';
      const areaText = formatArea(srcAddr);
      const areaMaps = mapsLinkForArea(srcAddr);

      card.innerHTML = `
        <h2 class="text-xl font-semibold">${church.name}
          <span class="text-sm font-normal opacity-70 ml-2">(${fmtKm(church.distance_km || church.distance)} km)</span>
        </h2>

        <p class="text-sm opacity-90 mt-1">
          <i class="fa-solid fa-location-dot mr-1"></i>${areaText}
        </p>

        <div class="mt-2 flex flex-wrap gap-2 items-center">
          <span class="inline-flex items-center px-2 py-1 rounded bg-gray-100 text-gray-900 text-xs font-medium">
            <i class="far fa-calendar-alt mr-1"></i>${church.day}
          </span>
          <span class="inline-flex items-center px-2 py-1 rounded bg-gray-100 text-gray-900 text-xs font-medium">
            <i class="far fa-clock mr-1"></i>${church.time}
          </span>
        </div>

        <p class="text-sm opacity-90 mt-3">
          <strong><i class="fas fa-phone mr-1"></i>Contato:</strong> ${church.contact}
        </p>

        <div class="mt-4 flex flex-wrap gap-2">
          ${whatsappLink ? `
            <a href="${whatsappLink}" target="_blank"
               class="inline-flex items-center px-4 py-2 bg-green-500 text-white rounded-md text-sm font-medium shadow-sm hover:bg-green-600 transition-colors">
              <i class="fab fa-whatsapp mr-2"></i>WhatsApp
            </a>` : ''}

          <a href="${areaMaps}" target="_blank"
             class="inline-flex items-center px-4 py-2 bg-[#2D2D2D] text-white rounded-md text-sm font-medium shadow-sm hover:bg-gray-700 transition-colors">
            <i class="fas fa-map-marker-alt mr-2"></i>Abrir no Maps
          </a>
        </div>
      `;
      return card;
    }

    form.addEventListener('submit', async (event) => {
      event.preventDefault();

      resultsDiv.innerHTML = '';
      qHead.classList.add('hidden');

      button.disabled = true;
      button.textContent = 'Buscando...';
      spinner.classList.remove('hidden');

      const addressInput = addressEl.value.trim();
      const isCEP = /^\d{5}-?\d{3}$/.test(addressInput);

      const body = { limit: Number(limitEl.value) || 3 };
      const md = Number(maxDistEl.value);
      if (isFinite(md) && md > 0) body.max_distance_km = md;

      if (isCEP) body.cep = addressInput;
      else body.address = addressInput;

      try {
        const response = await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body),
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || 'Erro na requisição.');
        }

        if (data.query?.input_address) {
          qAddr.textContent = data.query.input_address;
          if (data.query.maps_url) {
            qMaps.href = data.query.maps_url;
            qMaps.classList.remove('pointer-events-none', 'opacity-50');
          } else {
            qMaps.href = '#';
            qMaps.classList.add('pointer-events-none', 'opacity-50');
          }
          qHead.classList.remove('hidden');
        }

        const churches = data.nearest_churches || [];
        if (churches.length === 0) {
          resultsDiv.innerHTML = `<p class="text-center opacity-70">Nenhuma igreja encontrada${md ? ` no raio de ${md} km` : ''}. Tente detalhar mais o endereço ou ajustar os filtros.</p>`;
          return;
        }

        churches.forEach(ch => resultsDiv.appendChild(makeCard(ch)));

      } catch (error) {
        resultsDiv.innerHTML = `<p class="text-center text-red-600">Erro: ${error.message}</p>`;
      } finally {
        button.disabled = false;
        button.textContent = 'Buscar';
        spinner.classList.add('hidden');
      }
    });
  </script>
</body>
</html>
